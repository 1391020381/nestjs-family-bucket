- [后端工程师的高阶面经](https://time.geekbang.org/column/article/703160)

# MongoDB:MongoDB是怎么做到高可用的

## 为什么用MongoDB

1. MongoDB是灵活的文档模型。 数据模型会经常变动,这种情况下倾向于使用MongoDB
2. MongoDB 更容易进行横向扩展。 关系型数据库可以通过分库分表来达成横向扩展的目标, 在 MongoDB里面都是自动的，基本不需要操心。

- 对于一般中小型公司来说 MongoDB都不是必须使用的存储中间件,大部分时候使用关系型数据库也能应付一般的文档存储需求

## MongoDB的分片机制

- 当下,跟数据存储和检索有关的中间件基本上都会支持分片。
- 或者说我们步入了分布式时代之后诞生的中间件,基本上都会考虑分片机制。 MongoDB也不例外。

- 在MongoDB里，可以使用所谓的`分片集合(collection)`。`每一个分片集合都被分成若干个分片`，如果按照关系型数据库分库分表的说法,那么集合即时逻辑表，而分片就是物理表。

- 每个分片又由多个块(chunk)组成。在最新版本的默认情况下,一个块的大小是128MB

* 如果一个块满足了下面的两个条件的任何一个，就会被拆分成两个块。

  - 整个块的数据量过多了。比如说默认一个块时128MB，但是这个块上放的数据超过了128MB,那么就会拆分。
  - 块上面放了太多文档,这个阈值是平均每个块包含的文档数量的1.3倍。 也就是说如果平均每个块可以放1000个文档,如果当前块上面放了超过1300个文档,那么这个块会被拆分。

  - `简单记忆 数据太多 文档太多`

  - 在分库分表里面，经常会遇到的一个问题是，不同的表之间数据并不均衡,有的多有的少。
  - 所以就要求你在设计分库分表方案的时候,要尽可能准确预估每一个物理表的数据,确保均衡。

  - 而在MongoDB里面 它会自动平衡不同分片的数据,尽量做到每个分片都有差不多的数据量,整个机制也叫做 负载均衡。

  * 只不过 `一般意义上的负载均衡强调的是流量负载均衡,而这里是数据量负载均衡`

* 发现数据不均衡之后,迁移数据的过程也叫做再平衡(rebalance) 再平衡过程本质上就是挪动块。
* 再平衡触发条件
* 再平衡步骤

## MongoDB的配置服务器

- 当引入分片机制之后，MongoDB启用了配置服务器(config server) 来存储元数据。这些元数据包括分片信息 权限控制信息，用来控制分布式锁。其中分片信息还会被负责执行查询 mongos使用。
- MongoDB的配置服务器有一个很大的优点,就是就算主节点崩溃了,但是它还是可以继续提供读服务。
- 其他大多数中间件的主从结构都是在主节点崩溃之后完全不可用,直到选举出了一个新的主节点。

- 不管怎么说,配置服务器在MongoDB里面是一个非常关键的组件。 甚至可以说，一旦配置服务器有问题，就算只是轻微地性能抖动一下，对整个MongoDB集群的影响都是很大的。

## MongoDB的复制机制

- 可以把MongoDB的复制机制理解成MongoDB的主从机制。
- MongoDB的副本也是MongoDB实例，它们和主实例持有一样的数据。
- 在 MongoDB里面，用Primary来代表主实例,而用Secondary来代表副本实例。
- 主从实例合并在一起，也叫做一个复制集(Replica Set)
- 类似于数据库的读写分离机制 你也可以在MongoDB上进行读写分离。
- 既然有主从 就有 主从集群和数据同步。

## 写如语义

- 可以通过参数控制写入数据究竟写到哪里。 而写入语义对性能 可用性 和数据可靠性有显著的影响

## 面试准备
