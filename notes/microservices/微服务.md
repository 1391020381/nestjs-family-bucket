# 微服务架构

1. 服务注册与发现

- 比较好的策略是立刻重试几次,如果都失败了就再间隔一段时间继续重试。 所有的重试机制实际上也是要谨慎考虑重试次数和重试间隔的,确保在业务可以接受的范围内重试成功。
- 不过再怎么样，从服务端崩溃到客户端知道,中间总是存在一个时间误差的,这时候就需要客户端来做容错了。
- 客户端容错 客户端容错是指尽量在注册中心或者服务端节点出现问题的时候,依旧保证能够发送到正确的服务端节点上。

- C: Consistency 数据一致性
- A: Availability 服务可用性
- P: Partition-tolerance 分区容错性
- CAP 理论告诉我们 一个分布式系统不可能同时满足数据一致性 服务可用性和分区容错性这三个基本需求,最多只能同时满足其中的两个。

* P分区容错性是肯定要选的
* C一致性 A 服务可用性 A可用性更重要
* 最后应该选择 AP

2. 负载均衡
   - 静态负载均衡算法 轮询 加权轮询 随机和加权随机 哈希和一致性哈希 依靠的是统计学上的 最合适。也就是 请求都差不多 请求数量也足够多,那么它们能够挑选出比较合适的节点。
   - 动态负载均衡算法 / 实时检测负载均衡算法
3. 熔断
   - 判定服务的健康状态
     - 阈值如何选择
     - 超过阈值之后,要不要持续一段时间才触发熔断
4. 降级
   - 原则上来说,是应该优先考虑使用降级的。 然而有些服务时无法降级的，尤其是写服务。 例如你从前端接受数据,然后写到数据库,这种场景是无法降级的。 另外,如果你希望系统负载尽快降低,那么熔断要优于降级
   - 跨服务降级 停掉某些服务,保证核心服务。
   - 本服务提供有损服务
     - 返回默认值
     - 禁用可观测性组件 埋点
     - 同步转异步
     - 简化流程
5. 限流
   - 限流需要确定一个流量阈值，这个阈值该怎么计算？
   - 限流是通过限制住流量大小来保护系统,它尤其能够 解决异常突发流量打崩系统的问题。
   - 静态算法 令牌桶 漏桶 固定窗口 滑动窗口 这些算法要提前设置好阈值。 在运行期间它不会管服务器的真实负载的。
   - 动态算法-自适应限流算法 典型的BBR算法。
6. 隔离
   - 在出现故障的时候 隔离可以把影响限制在一个可以忍受的范围内。
7. 超时控制
   - 能够节省系统资源 提高资源的有效利用率
   - 超时控制是指在规定的时间内完成操作,如果不能完成,那么就返回一个超时响应。
   - 确定超时时间 根据用户体验来确定 根据被调用接口的响应时间来确定 根据压测结果来确定 根据代码来确定
8. 优雅调用第三方
   - 提供一个一致性抽象 屏蔽不同第三方平台API之间差异
   - 提供客户端治理 即提供调用第三方平台API的重试 限流等功能
   - 提供可观测支持
   - 提供测试支持
9. 综合服务治理方案:怎么保证微服务应用的高可用
   - 容错
   - 限制故障影响范围
   - 出现故障可以快速发现 快速修复
   - 规范变更流程
