* [一篇讲透自研的前端错误监控](https://juejin.cn/post/6987681953424080926)


# window.onerror
* window.onerror 当JS运行时错误发生时,window会触发一个Error接口的error事件。
* 常规运行时错误 可以捕获
* 异步错误 可以捕获
* 
* 语法错误   资源错误 不能捕获

```

/**
* @param {String}  message    错误信息
* @param {String}  source    出错文件
* @param {Number}  lineno    行号
* @param {Number}  colno    列号
* @param {Object}  error  Error对象
*/

window.onerror = function(message, source, lineno, colno, error) {
   console.log('捕获到异常：', {message, source, lineno, colno, error});
}


```

# window.addEventListener
*   window.addEventListener('error', (error) => {
     console.log('捕获到异常：', error);
  }, true)
* 当一项资源(图片或脚本)加载失败 加载资源的元素会触发一个Event接口的error事件,这些error事件不会向上冒泡到 window 但能被捕获。 而 window.onerror 不能检测捕获。

* new Image 错误不能捕获 运用的少 可单独处理


# unhandledrejection

```
// 全局统一处理Promise
window.addEventListener("unhandledrejection", function(e){
  console.log('捕获到异常：', e);
});
fetch('https://tuia.cn/test')


```


# Vue错误

```
/**
 * 全局捕获Vue错误，直接扔出给onerror处理
 */
Vue.config.errorHandler = function (err) {
  setTimeout(() => {
    throw err
  })
}



```

# React错误
* react 通过componentDidCatch，声明一个错误边界的组件
* 但error boundaries并不会捕捉以下错误：React事件处理，异步代码，error boundaries自己抛出的错误
```

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    // 更新 state 使下一次渲染能够显示降级后的 UI
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    // 你同样可以将错误日志上报给服务器
    logErrorToMyService(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      // 你可以自定义降级后的 UI 并渲染
      return <h1>Something went wrong.</h1>;
    }

    return this.props.children; 
  }
}

class App extends React.Component {
   
  render() {
    return (
    <ErrorBoundary>
      <MyWidget />
    </ErrorBoundary>  
    )
  }
}




```

# 跨域问题
* 一般情况，如果出现 Script error 这样的错误，基本上可以确定是出现了跨域问题。

* 后端配置Access-Control-Allow-Origin、前端script加crossorigin。



# 上报
* 使用new Image进行接口上报。最后一个问题，同样都是图片，上报时选用了1x1的透明GIF
* navigator.sendBeacon(url, data);
* [Navigator.sendBeacon 无阻塞发送统计数据](https://juejin.cn/post/6844903982054244365)